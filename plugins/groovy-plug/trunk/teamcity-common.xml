<?xml version="1.0" encoding="UTF-8"?>
<project name="TeamCityPluginCommon" default="dist">

  <!--
    # required properties
    plugin.name=samplePlugin
    teamcity.data.path=path.to.BuildServer

    # either plugin.output.server or plugin.output.agent should be defined
    plugin.output.server=path.to.compiled.server.plugin.output
    plugin.output.agent=path.to.compiled.agent.plugin.output

    # necessary if "deploy" target is used
    path.variable.teamcitydistribution=path.to.unpacked.tar.gz.TeamCity.distribution"/>
  -->


  <property name="dist" value="dist"/>
  <property name="dist.unpacked" value="${dist}/unpacked"/>
  <property name="distrib.prep" value="${basedir}/temp/dist_prep"/>
  <property name="distrib.prep.server" value="${distrib.prep}/server"/>
  <property name="distrib.prep.agent" value="${distrib.prep}/agent"/>
  <property name="distrib.prep.agent.jars" value="${distrib.prep.agent}/unpacked"/>

  <target name="prepare.server.part" if="plugin.output.server">
    <mkdir dir="${distrib.prep.server}"/>

    <copydir src="${plugin.output.server}" dest="${distrib.prep.server}"/>
    <copy todir="${distrib.prep.server}/buildServerResources" failonerror="false">
      <fileset dir="${basedir}/buildServerResources"/>
    </copy>

    <jar destfile="${dist.unpacked}/${plugin.name}.jar">
      <fileset dir="${distrib.prep.server}"/>
    </jar>
  </target>

  <target name="prepare.agent.part" if="plugin.output.agent">
    <delete dir="${dist}/agent" quiet="true"/>
    <mkdir dir="${distrib.prep.agent}"/>
    <mkdir dir="${distrib.prep.agent.jars}/${plugin.name}/lib"/>
    <mkdir dir="${dist.unpacked}/agent"/>

    <jar destfile="${distrib.prep.agent.jars}/${plugin.name}/lib/${plugin.name}.jar">
      <fileset dir="${plugin.output.agent}"/>
    </jar>

    <zip destfile="${dist.unpacked}/agent/${plugin.name}.zip">
      <fileset dir="${distrib.prep.agent.jars}"/>
    </zip>
  </target>

  <target name="build.jar" depends="all">
    <delete dir="${dist.unpacked}" quiet="true"/>
    <delete dir="${distrib.prep}" quiet="true"/>

    <mkdir dir="${dist}"/>
    <mkdir dir="${dist.unpacked}"/>

    <antcall target="prepare.server.part"/>
    <antcall target="prepare.agent.part"/>

    <delete dir="${distrib.prep}" quiet="true"/>
  </target>

  <target name="package" depends="check, build.jar">
    <delete file="${dist}/${plugin.name}.zip" quiet="true"/>
    <zip destfile="${dist}/${plugin.name}.zip">
      <fileset dir="${dist.unpacked}"/>
    </zip>
    <echo message="To install the plugin, place '${dist}\${plugin.name}.zip' into '.BuildServer/plugins' directory"/>
  </target>

  <target name="check">
    <check.property name="plugin.name"/>
    <check.property name="path.variable.teamcitydistribution"
                    fail-message="Please define the property in build.properties file. The property should point to unpacked TeamCity .tar.gz or .exe distribution."/>

    <condition property="is.configured.output.paths">
      <not>
        <or>
          <and>
            <isset property="plugin.output.server"/>
            <length string="${plugin.output.server}" when="greater" length="0"/>
          </and>
          <and>
            <isset property="plugin.output.agent"/>
            <length string="${plugin.output.agent}" when="greater" length="0"/>
          </and>
        </or>
      </not>
    </condition>
    <fail if="is.configured.output.paths"
          message="Nither 'plugin.output.server' nor 'plugin.output.agent' properties are defined. The properties should point to compiled resources of server/agent plugin part."/>

  </target>

  <macrodef name="check.property">
    <attribute name="name"/>
    <attribute name="fail-message" default=""/>
    <sequential>
      <condition property="is.configured.@{name}">
        <not>
          <and>
            <isset property="@{name}"/>
            <length string="${@{name}}" when="greater" length="0"/>
          </and>
        </not>
      </condition>
      <fail if="is.configured.@{name}"
            message="Property '@{name}' not defined. @{fail-message}"/>
    </sequential>
  </macrodef>

  <!-- TeamCity distribution unpacking -->
  <target name="teamcity.unpack">

    <property name="distribution.dir" value="${basedir}/teamcity-dist"/>
    <property name="teamcity.tar.gz-location" value="."/>

    <delete dir="${distribution.dir}" quiet="true"/>
    <mkdir dir="${distribution.dir}"/>

    <untar compression="gzip" dest="${distribution.dir}">
      <fileset dir="${teamcity.tar.gz-location}">
        <include name="*.tar.gz"/>
      </fileset>
    </untar>

    <move todir="${distribution.dir}">
      <fileset dir="${distribution.dir}\TeamCity">
        <include name="**"/>
      </fileset>
    </move>
  </target>

  <target name="deploy" depends="dist">
    <check.property name="teamcity.data.path" fail-message="Should store path to TeamCity .BuildServer directory."/>
    <property name="plugin.deploy.dir" value="${teamcity.data.path}/plugins"/>

    <!-- copy plugin -->
    <mkdir dir="${plugin.deploy.dir}"/>
    <copy todir="${plugin.deploy.dir}">
      <fileset file="${dist}/${plugin.name}.zip"/>
    </copy>
  </target>

  <target name="undeploy">
    <delete file="${plugin.deploy.dir}/${plugin.name}.zip" quiet="true"/>
    <delete>
      <fileset dir="${teamcity.tar.gz-location}">
        <include name="*.tar.gz"/>
      </fileset>
    </delete>
  </target>


</project>